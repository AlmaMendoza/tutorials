---
title: "Changing inputs in MAgPIE model"
author: "Mi&#x0161;ko Stevanovi&#x0107; (stevanovic@pik-potsdam.de)"
output:
  html_notebook: default
  html_document: default
  pdf_document: default
  word_document: default
subtitle: MAgPIE model development team (magpie@pik-potsdam.de)
---

# 1. Introduction

The input data for MAgPIE is prepared by a set of pre-processing routines that take the data from original sources (e.g. FAO, LPJmL...), execute additional calculations and convert it to the required MAgPIE parameter format. These pre-processing routines are not accessible as open source at the moment. A user is instead provided with a readymade inputs that are necessary for the model execution. 

The input files are setup in the config file `config/default.cfg`, usually at the beginning of the settings. Currently, the input data is set as: 

```{r}
cfg$input <- "magpie4.0_default_sep18.tgz"
```

The prepared input data is a compressed tar archive file "`.tgz`", which can be opened with software such as [7-Zip](https://www.7-zip.org/), or in terminal by `tar` and `untar` commands. The data archive file contains the following types of data: 

* climate depended bio-physical data from a crop model (region and cell specific, crop yields, water requirements, terrestrial carbon content...) 
* processed data from other data sources used for parametrizatino of MAgPIE (FAO, SSP, GTAP...)
* processed data from other data sources used for validation of MAgPIE output
* additional data prepared for model parametrization (national policies...)
* calibration factors 


## 2. Demonstration of change in input data for national land-based NDC policies

Once the input data is downloaded to the local MAgPIE repository in forms of different input files in designated input folders (in the core, scripts, modules and module realizations), a user can update or change these input data files. This can be done directly my manipulating the files, but this apporach carries a risk that such changes are not documented and that in certain cases the made changes can be overwriten by the repeated download of the date from the declared repositories. In order to avoid this risk, it is recomended to create a local folder the serves as a repository for the patch files that will apply changes to the data by overwriting the original data.  

### 2.1. Create folder for local input data repository

The folder for local input data reporistry can be created anywhere and it's path must be provided to the settings in `config/default.cfg` file. 

Let us assume that the patch folder (`patch_inputdata`) is created in the main MAgPIE reporsity. One can do it in R: 

```{r}
dir.create("./patch_inputdata")
```
or in the command line:
```{cmd}
mkdir patch_inputdata
```

Once the directory is created, provide its location to the configuration file. It's important to keep the list structure of the reporsotory information: 
```{r}
cfg$repositories <- append(list("https://rse.pik-potsdam.de/data/magpie/public"=NULL,
                                "./patch_inputdata"=NULL),
                           getOption("magpie_repos"))
```


### 2.2. Create a patched file policy_definition.csv and package it with lucode::tardir()

Create a subdirectory in the `./patch_inputdata` which is going to be used for packaging of the patched files. 
```{eval=FALSE}
dir.create("./patch_inputdata/patch_ndc_usa_181206")
```


Copy the original file the `policy_definition.csv` in the patch floder. 
In R: 
```{r}
file.copy(from="./scripts/npi_ndc/policies/policy_definitions.csv",to="./patch_inputdata/patch_ndc_usa_181206/.")
```
or in the command line:
```{cmd}
cp scripts/npi_ndc/policies/policy_definitions.csv patch_inputdata/patch_ndc_usa_181206/.
```

Edit the content, in this case update the USA  afforestation NDC policy (`affore`) with a more ambitous target of 15 MHa of afforested area starting in 2020 and reaching the target at 2030:  
```{txt}
USA,affore,ndc,1,2020,2030,15
```

After saving the file package it with the tardir function in R only: 
```{r}
lucode::tardir(dir=)
```




### 2.3. Store patch as patch.tgz in the local repository

### 2.4. Add it to cfg$repositories

### 2.5. Add patch.tgz at the end of cfg$input

# 3. Additional information 

There are other pre-processed input data that have different regional resolution. 