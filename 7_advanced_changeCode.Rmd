---
title: "Advanced: Change MAgPIE GAMS Code"
subtitle: MAgPIE model development team (magpie@pik-potsdam.de)
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: Florian HumpenÃ¶der (humpenoeder@pik-potsdam.de)
output:
  pdf_document: default
  toc: yes
  toc_float: true
  html_notebook:
    code_folding: none
---

### 1. Learning objectives
MAgPIE has a modular concept. Each module (e.g. cropland) can have several realization (e.g. dynamic and static).
This tutorial shows how to add new realizations and how to modify existing realizations.

### 2. Adding a new realization (cropland)
We want to add a new realization to the cropland module.
In the MAgPIE 4.1 release the cropland module (30_crop) has only one realization called "endo_jun13". In this realization irrigation of bioenergy crops is prohibited. We will add a new realization, based on "endo_jun13", which allows for irrigation of bioenergy crops. We will call the new  realization "bioen_irrig".

#### Create a new realization by copying an existing one
We first copy-paste the folder "endo_jun13" and the file "endo_jun13.gms" (both located in "modules/30_crop"), and rename them to "bioen_irrig" and "bioen_irrig.gms" respectivly.

#### Include it properly via lucode::update_modules_embedding()
To include the new realization "bioen_irrig" properly into the GAMS code we run a specific R command in the main folder. First navigate in your command line to the MAgPIE main folder, then open a new R session (type "R" followed by ENTER), and then copy-paste the following R command: `lucode::update_modules_embedding()`

#### Do a simple modification in the new realization
The prohibition of irrigated bioenergy is specified in the file "presolve.gms" within the "bioen_irrig" realization.
We just have to remove (or comment out) lines 8-9 from this file to allow for irrigation of bioenergy crops. 

`*vm_area.fx(j,"begr","irrigated")=0;`

`*vm_area.fx(j,"betr","irrigated")=0;`

Finally, we run `lucode::update_fulldataOutput()` to update the automatic GAMS code declarations and output definitions. 

Note: This command is not needed for this exercise. But if you change, add or delete variables/parameters this command is of high importance to avoid GAMS compilation errors.

#### Set the new realization in cfg and test the model
For a quick test, we simply set the new realization in the file main.gms in line 179 (replace `endo_jun13` by `bioen_irrig`). We can then check if the model compiles correctly with `gams main.gms action=C`

For starting a model run, we would have to make a change in the config file `config/default.cfg` in line 219 (replace `endo_jun13` by `bioen_irrig`). We could then start a model run with `Rscript start.R -> 1: default -> 1: Direct execution`.

### 3. Changing an existing realization (cropland)
Instead of adding a new realization, we can also include a switch for irrigation of bioenergy crops in the existing realization (30_crop).

#### Define the switch in declarations.gms
We add the following code to declarations.gms:
```{r, eval=FALSE}
scalars
  s30_bioen_irrig  switch for irrigation of bioenergy crops (0 or Inf)          / 0 /
;
```

#### Change presolve.gms
In presolve.gms we replace lines 8-9 with the following:
```{r, eval=FALSE}
vm_area.up(j,"begr","irrigated")=s30_bioen_irrig;
vm_area.up(j,"betr","irrigated")=s30_bioen_irrig
m_boundfix(vm_area,(j,kcr,w),l,10e-5);
```

#### Add to config
We can then add `s30_bioen_irrig` to the config file `config/default.cfg`, after line 219.
```{r, eval=FALSE}
# * (s30_bioen_irrig): switch for irrigation of bioenergy crops (0 or Inf)  
cfg$gms$s30_bioen_irrig <- Inf               # def = 0
```

#### Quick test
For a quick test, we change back to the original cropland realization in the file main.gms in line 179 (replace `bioen_irrig` by `endo_jun13`). We can then check if the model compiles correctly with `gams main.gms action=C`

### 4. Changing an existing realization (TC)
In this example, we add an upper bound for the land-use intensity (TAU factor) in the TC (technological change) module. 